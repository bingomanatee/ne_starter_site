var async = require('async');
var util = require('util');
var _ = require('underscore');

module.exports = function (model, generator, count, callback, dont_return, preserve) {
    var done = 0;
    var docs = [];
    var errs = [];
    var aborted = false;
    var killjoy;

    function _make() {
        console.log('making %s %s s', count, model.name);
        var index;
        for (index = 0; index < count; ++index) {
            var doc = generator(index);

            var cb = function (index) {
                var i = index;
                return function (err, doc) {
                    if (aborted) {
                        return;
                    }
                    if (!dont_return) {
                        if (err) {
                            docs[i] = err;
                        } else {
                            docs[i] = false;
                            errs[i] = err;
                        }
                    }
                    ++done;
                    console.log('model %s of %s made', done, count);
                    if (done < count) {
                        console.log('...');
                    } else {
                        callback(null, {docs:docs, errs:errs});
                        clearTimeout(killjoy);
                        console.log('DONE MAKING MODELS');
                    }
                }
            }

            model.put(doc, cb());

        }

         killjoy = setTimeout(function () {
            aborted = true;
            callback(new Error('factory took too long'));
        }, 100 * count);
    }

    if (!preserve) {
        model.empty();
    }

    _make();

}